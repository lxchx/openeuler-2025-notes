<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{TITLE}}</title>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700;800&family=Noto+Sans+SC:wght@400;600;700;800&display=swap");
      :root {
        color-scheme: dark;
        --bg: #07090f;
        --bg-2: #0e1320;
        --panel: rgba(255, 255, 255, 0.06);
        --panel-strong: rgba(255, 255, 255, 0.1);
        --border: rgba(255, 255, 255, 0.12);
        --text: rgba(255, 255, 255, 0.92);
        --muted: rgba(255, 255, 255, 0.62);
        --accent: #4cc3ff;
        --accent-2: #2bd3a5;
        --shadow: 0 24px 70px rgba(0, 0, 0, 0.45);
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        background:
          radial-gradient(1200px 720px at 10% -10%, rgba(76, 195, 255, 0.2), transparent 60%),
          radial-gradient(900px 680px at 100% 0%, rgba(43, 211, 165, 0.15), transparent 62%),
          linear-gradient(180deg, rgba(255, 255, 255, 0.05), transparent 38%),
          var(--bg);
        color: var(--text);
        font-family: "Manrope", "Noto Sans SC", system-ui, -apple-system, sans-serif;
      }
      a { color: inherit; }
      header {
        position: sticky;
        top: 0;
        z-index: 10;
        backdrop-filter: blur(18px) saturate(160%);
        -webkit-backdrop-filter: blur(18px) saturate(160%);
        background: rgba(7, 9, 15, 0.7);
        border-bottom: 1px solid var(--border);
      }
      .topbar {
        max-width: 1200px;
        margin: 0 auto;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding: 14px 18px;
      }
      .brand {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }
      .brand-title {
        font-weight: 800;
        letter-spacing: 0.3px;
        font-size: 16px;
      }
      .brand-sub {
        font-size: 12px;
        color: var(--muted);
      }
      .top-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      .btn {
        border: 1px solid var(--border);
        background: var(--panel);
        color: var(--text);
        padding: 6px 12px;
        border-radius: 999px;
        font-size: 12px;
        cursor: pointer;
        transition: transform 0.12s ease, border-color 0.12s ease, background 0.12s ease;
      }
      .btn:hover { transform: translateY(-1px); border-color: rgba(76, 195, 255, 0.6); }
      .layout {
        max-width: 1200px;
        margin: 0 auto;
        display: grid;
        grid-template-columns: minmax(0, 1fr) 280px;
        gap: 20px;
        padding: 20px 18px 60px;
      }
      .toc {
        position: sticky;
        top: 92px;
        align-self: start;
        border: 1px solid var(--border);
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.04));
        border-radius: 14px;
        padding: 14px;
        box-shadow: var(--shadow);
        display: flex;
        flex-direction: column;
        gap: 8px;
        max-height: calc(100vh - 120px);
        overflow: hidden;
      }
      .toc h3 {
        margin: 0 0 10px;
        font-size: 13px;
        letter-spacing: 0.3px;
        text-transform: uppercase;
        color: var(--muted);
      }
      .toc input {
        width: 100%;
        margin-bottom: 10px;
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 8px 10px;
        background: rgba(10, 12, 18, 0.9);
        color: var(--text);
        font-size: 12px;
      }
      .toc nav { overflow: auto; min-height: 0; padding-right: 4px; }
      .toc nav::-webkit-scrollbar { width: 6px; }
      .toc nav::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.18); border-radius: 999px; }
      .toc nav::-webkit-scrollbar-track { background: transparent; }
      .toc ul { list-style: none; padding-left: 0; margin: 0; }
      .toc li { margin: 3px 0; }
      .toc a {
        text-decoration: none;
        font-size: 12px;
        color: var(--muted);
        display: block;
        padding: 4px 6px;
        border-radius: 6px;
      }
      .toc a.active { color: var(--text); background: rgba(76, 195, 255, 0.18); }
      .toc li[data-level="1"] > a { font-size: 13px; font-weight: 700; }
      .toc li[data-level="2"] > a { padding-left: 12px; font-size: 12px; opacity: 0.92; }
      .toc li[data-level="3"] > a { padding-left: 22px; font-size: 11px; opacity: 0.78; }
      .toc li[data-level="4"] > a { padding-left: 30px; font-size: 10.5px; opacity: 0.7; }
      .doc {
        border: 1px solid var(--border);
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.02));
        border-radius: 18px;
        padding: 24px 24px 36px;
        box-shadow: var(--shadow);
      }
      .doc h1, .doc h2, .doc h3, .doc h4 {
        scroll-margin-top: 110px;
        position: relative;
      }
      .doc h1 { font-size: 26px; margin-top: 28px; }
      .doc h2 { font-size: 20px; margin-top: 24px; }
      .doc h3 { font-size: 17px; margin-top: 20px; }
      .doc h4 { font-size: 15px; margin-top: 18px; }
      .doc p { line-height: 1.7; color: rgba(255, 255, 255, 0.86); }
      .doc ul, .doc ol { padding-left: 22px; line-height: 1.7; }
      .doc ul { list-style: none; }
      .doc ul > li { position: relative; padding-left: 4px; }
      .doc ul > li::before {
        content: "•";
        position: absolute;
        left: -16px;
        top: 0.2em;
        color: rgba(255, 255, 255, 0.55);
      }
      .doc ul > li.has-toggle::before { content: ""; }
      .doc li > p { margin: 0; }
      .doc code {
        background: rgba(76, 195, 255, 0.15);
        padding: 2px 6px;
        border-radius: 6px;
        font-size: 0.92em;
      }
      .doc pre {
        background: rgba(10, 12, 18, 0.8);
        padding: 14px;
        border-radius: 12px;
        overflow: auto;
        border: 1px solid rgba(255, 255, 255, 0.08);
      }
      .doc blockquote {
        margin: 16px 0;
        padding: 12px 14px;
        border-left: 3px solid var(--accent);
        background: rgba(255, 255, 255, 0.04);
      }
      .section-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 8px;
      }
      .section-header .section-title { margin: 0; }
      .doc-section { margin-top: 20px; }
      .doc-section.level-1 { margin-top: 28px; }
      .doc-section.level-2 { margin-top: 22px; }
      .doc-section.level-3 { margin-top: 18px; }
      .doc-section.level-4 { margin-top: 16px; }
      .doc-section:first-child { margin-top: 0; }
      .section-toggle {
        border: none;
        background: rgba(76, 195, 255, 0.16);
        color: var(--text);
        width: 22px;
        height: 22px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 12px;
      }
      .doc-section.collapsed .section-body { display: none; }
      .list-toggle {
        border: none;
        background: rgba(255, 255, 255, 0.12);
        color: var(--text);
        border-radius: 6px;
        width: 18px;
        height: 18px;
        font-size: 11px;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }
      .doc ul .list-toggle {
        position: absolute;
        left: -18px;
        top: 0.25em;
      }
      .doc ol .list-toggle {
        margin-right: 6px;
      }
      li.list-collapsed > ul,
      li.list-collapsed > ol {
        display: none;
      }
      .toolbar {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 18px;
      }
      .progress {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 3px;
        background: rgba(76, 195, 255, 0.15);
        z-index: 20;
      }
      .progress > span {
        display: block;
        height: 100%;
        width: 0;
        background: linear-gradient(90deg, var(--accent), var(--accent-2));
        transition: width 0.1s ease-out;
      }
      .back-top {
        position: fixed;
        right: 20px;
        bottom: 20px;
        border: 1px solid var(--border);
        background: rgba(10, 12, 18, 0.85);
        color: var(--text);
        border-radius: 999px;
        padding: 8px 12px;
        font-size: 12px;
        cursor: pointer;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s ease;
      }
      .back-top.show { opacity: 1; pointer-events: auto; }
      @media (max-width: 960px) {
        .layout { grid-template-columns: 1fr; }
        .toc { position: static; order: -1; }
      }
    </style>
  </head>
  <body>
    <div class="progress"><span id="progress-bar"></span></div>
    <header>
      <div class="topbar">
        <div class="brand">
          <div class="brand-title">分析稿</div>
          <div class="brand-sub">TalkDistill 输出 · 阅读版</div>
        </div>
        <div class="top-actions">
          <a class="btn" href="index.html">返回入口</a>
          <button class="btn" id="toggle-toc">目录</button>
        </div>
      </div>
    </header>

    <main class="layout">
      <article class="doc">
        <div class="toolbar">
          <button class="btn" id="collapse-headings">折叠标题</button>
          <button class="btn" id="expand-headings">展开标题</button>
          <button class="btn" id="collapse-lists">折叠列表</button>
          <button class="btn" id="expand-lists">展开列表</button>
        </div>
        <div id="doc-content"></div>
      </article>

      <aside class="toc" id="toc">
        <h3>目录</h3>
        <input type="search" id="toc-filter" placeholder="过滤标题（/ 可快速定位）" />
        <nav id="toc-list"></nav>
      </aside>
    </main>

    <button class="back-top" id="back-top">回到顶部</button>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script id="doc-source" type="text/markdown">{{MD_CONTENT}}</script>
    <script>
      const source = document.getElementById("doc-source").textContent;
      const content = document.getElementById("doc-content");
      const tocList = document.getElementById("toc-list");
      const tocFilter = document.getElementById("toc-filter");
      const toc = document.getElementById("toc");
      const backTop = document.getElementById("back-top");

      marked.setOptions({ gfm: true, breaks: true });
      content.innerHTML = marked.parse(source);

      function slugify(text) {
        return text
          .toLowerCase()
          .trim()
          .replace(/[^\w\u4e00-\u9fa5\s-]/g, "")
          .replace(/\s+/g, "-")
          .slice(0, 60);
      }

      function wrapSections() {
        const nodes = Array.from(content.childNodes);
        content.innerHTML = "";
        let i = 0;
        while (i < nodes.length) {
          const node = nodes[i];
          if (node.nodeType === 1 && /^H[1-4]$/.test(node.tagName)) {
            const level = Number(node.tagName[1]);
            const section = document.createElement("section");
            section.className = `doc-section level-${level}`;
            const header = document.createElement("div");
            header.className = "section-header";
            const toggle = document.createElement("button");
            toggle.className = "section-toggle";
            toggle.textContent = "–";
            toggle.addEventListener("click", () => {
              section.classList.toggle("collapsed");
              toggle.textContent = section.classList.contains("collapsed") ? "+" : "–";
            });
            node.classList.add("section-title");
            header.appendChild(toggle);
            header.appendChild(node);
            section.appendChild(header);
            const body = document.createElement("div");
            body.className = "section-body";
            i += 1;
            while (i < nodes.length) {
              const next = nodes[i];
              if (next.nodeType === 1 && /^H[1-4]$/.test(next.tagName)) {
                const nextLevel = Number(next.tagName[1]);
                if (nextLevel <= level) break;
              }
              body.appendChild(next);
              i += 1;
            }
            section.appendChild(body);
            content.appendChild(section);
          } else {
            content.appendChild(node);
            i += 1;
          }
        }
      }

      function buildToc() {
        const headings = Array.from(content.querySelectorAll("h1, h2, h3, h4"));
        const used = new Map();
        const items = headings.map((h) => {
          const text = h.textContent.trim();
          const base = slugify(text) || "section";
          const count = (used.get(base) || 0) + 1;
          used.set(base, count);
          const id = count > 1 ? `${base}-${count}` : base;
          h.id = id;
          return { id, text, level: Number(h.tagName[1]) };
        });

        const root = document.createElement("ul");
        let stack = [{ level: 1, list: root }];
        items.forEach((item) => {
          while (stack.length > 1 && item.level <= stack[stack.length - 1].level) stack.pop();
          const li = document.createElement("li");
          li.dataset.level = item.level;
          const link = document.createElement("a");
          link.href = `#${item.id}`;
          link.textContent = item.text;
          li.appendChild(link);
          stack[stack.length - 1].list.appendChild(li);
          const sub = document.createElement("ul");
          li.appendChild(sub);
          stack.push({ level: item.level, list: sub });
        });
        tocList.innerHTML = "";
        tocList.appendChild(root);
      }

      function enableListToggles() {
        const items = content.querySelectorAll("li");
        items.forEach((li) => {
          const sub = li.querySelector(":scope > ul, :scope > ol");
          if (!sub) return;
          if (li.querySelector(".list-toggle")) return;
          const btn = document.createElement("button");
          btn.className = "list-toggle";
          btn.textContent = "▾";
          btn.type = "button";
          btn.setAttribute("aria-label", "折叠列表");
          btn.addEventListener("click", (e) => {
            e.stopPropagation();
            li.classList.toggle("list-collapsed");
            btn.textContent = li.classList.contains("list-collapsed") ? "▸" : "▾";
          });
          li.classList.add("has-toggle");
          const target = li.querySelector(":scope > p") || li;
          target.insertBefore(btn, target.firstChild);
        });
      }

      function setupTocSpy() {
        const links = Array.from(tocList.querySelectorAll("a"));
        const map = new Map(links.map((a) => [a.getAttribute("href").slice(1), a]));
        const headings = Array.from(document.querySelectorAll("h1, h2, h3, h4"));
        const setActive = (id) => {
          links.forEach((l) => l.classList.remove("active"));
          const link = map.get(id);
          if (link) link.classList.add("active");
        };
        let ticking = false;
        const update = () => {
          ticking = false;
          const offset = 120;
          let current = headings[0];
          for (const h of headings) {
            if (h.getBoundingClientRect().top - offset <= 0) current = h;
            else break;
          }
          if (current) setActive(current.id);
        };
        const onScroll = () => {
          if (ticking) return;
          ticking = true;
          requestAnimationFrame(update);
        };
        window.addEventListener("scroll", onScroll, { passive: true });
        window.addEventListener("resize", onScroll);
        update();
      }

      function setupToolbar() {
        document.getElementById("collapse-headings").onclick = () => {
          content.querySelectorAll(".doc-section").forEach((sec) => sec.classList.add("collapsed"));
        };
        document.getElementById("expand-headings").onclick = () => {
          content.querySelectorAll(".doc-section").forEach((sec) => sec.classList.remove("collapsed"));
        };
        document.getElementById("collapse-lists").onclick = () => {
          content.querySelectorAll("li").forEach((li) => li.classList.add("list-collapsed"));
          content.querySelectorAll(".list-toggle").forEach((btn) => (btn.textContent = "▸"));
        };
        document.getElementById("expand-lists").onclick = () => {
          content.querySelectorAll("li").forEach((li) => li.classList.remove("list-collapsed"));
          content.querySelectorAll(".list-toggle").forEach((btn) => (btn.textContent = "▾"));
        };
      }

      function setupProgress() {
        const bar = document.getElementById("progress-bar");
        const doc = document.querySelector(".doc");
        const onScroll = () => {
          const scrollTop = window.scrollY;
          const start = doc ? doc.offsetTop : 0;
          const end = doc ? doc.offsetTop + doc.scrollHeight - window.innerHeight : 0;
          const denom = Math.max(1, end - start);
          const ratio = (scrollTop - start) / denom;
          const clamped = Math.min(1, Math.max(0, ratio));
          bar.style.width = `${Math.min(100, clamped * 100)}%`;
          if (scrollTop > 360) backTop.classList.add("show");
          else backTop.classList.remove("show");
        };
        window.addEventListener("scroll", onScroll, { passive: true });
        onScroll();
      }

      function setupTocFilter() {
        tocFilter.addEventListener("input", () => {
          const q = tocFilter.value.trim().toLowerCase();
          tocList.querySelectorAll("a").forEach((a) => {
            const hit = a.textContent.toLowerCase().includes(q);
            a.parentElement.style.display = hit ? "" : "none";
          });
        });
        window.addEventListener("keydown", (e) => {
          if (e.key === "/") {
            e.preventDefault();
            tocFilter.focus();
          }
        });
      }

      function setupTocToggle() {
        document.getElementById("toggle-toc").addEventListener("click", () => {
          toc.style.display = toc.style.display === "none" ? "" : "none";
        });
      }

      backTop.addEventListener("click", () => window.scrollTo({ top: 0, behavior: "smooth" }));

      wrapSections();
      buildToc();
      enableListToggles();
      setupToolbar();
      setupTocSpy();
      setupProgress();
      setupTocFilter();
      setupTocToggle();
    </script>
  </body>
</html>
