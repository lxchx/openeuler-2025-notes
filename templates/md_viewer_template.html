<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{TITLE}}</title>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700;800&family=Noto+Sans+SC:wght@400;600;700;800&display=swap");
      :root {
        color-scheme: dark;
        --bg: #07090f;
        --bg-2: #0e1320;
        --panel: rgba(255, 255, 255, 0.06);
        --panel-strong: rgba(255, 255, 255, 0.1);
        --border: rgba(255, 255, 255, 0.12);
        --text: rgba(255, 255, 255, 0.92);
        --muted: rgba(255, 255, 255, 0.62);
        --accent: #4cc3ff;
        --accent-2: #2bd3a5;
        --shadow: 0 24px 70px rgba(0, 0, 0, 0.45);
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        background:
          radial-gradient(1200px 720px at 10% -10%, rgba(76, 195, 255, 0.2), transparent 60%),
          radial-gradient(900px 680px at 100% 0%, rgba(43, 211, 165, 0.15), transparent 62%),
          linear-gradient(180deg, rgba(255, 255, 255, 0.05), transparent 38%),
          var(--bg);
        color: var(--text);
        font-family: "Manrope", "Noto Sans SC", system-ui, -apple-system, sans-serif;
      }
      a { color: inherit; }
      header {
        position: sticky;
        top: 0;
        z-index: 10;
        backdrop-filter: blur(18px) saturate(160%);
        -webkit-backdrop-filter: blur(18px) saturate(160%);
        background: rgba(7, 9, 15, 0.7);
        border-bottom: 1px solid var(--border);
      }
      .topbar {
        max-width: 1200px;
        margin: 0 auto;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding: 14px 18px;
      }
      .brand {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }
      .brand-title {
        font-weight: 800;
        letter-spacing: 0.3px;
        font-size: 16px;
      }
      .brand-sub {
        font-size: 12px;
        color: var(--muted);
      }
      .top-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      .btn {
        border: 1px solid var(--border);
        background: var(--panel);
        color: var(--text);
        padding: 6px 12px;
        border-radius: 999px;
        font-size: 12px;
        cursor: pointer;
        transition: transform 0.12s ease, border-color 0.12s ease, background 0.12s ease;
      }
      .btn:hover { transform: translateY(-1px); border-color: rgba(76, 195, 255, 0.6); }
      .layout {
        max-width: 1200px;
        margin: 0 auto;
        display: grid;
        grid-template-columns: minmax(0, 1fr) 280px;
        gap: 20px;
        padding: 20px 18px 60px;
      }
      .toc {
        position: sticky;
        top: 92px;
        align-self: start;
        border: 1px solid var(--border);
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.04));
        border-radius: 14px;
        padding: 14px;
        box-shadow: var(--shadow);
        display: flex;
        flex-direction: column;
        gap: 8px;
        max-height: calc(100vh - 120px);
        overflow: hidden;
      }
      .toc h3 {
        margin: 0 0 10px;
        font-size: 13px;
        letter-spacing: 0.3px;
        text-transform: uppercase;
        color: var(--muted);
      }
      .toc input {
        width: 100%;
        margin-bottom: 10px;
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 8px 10px;
        background: rgba(10, 12, 18, 0.9);
        color: var(--text);
        font-size: 12px;
      }
      .toc nav { overflow: auto; min-height: 0; padding-right: 4px; }
      .toc nav { flex: 1; }
      .toc nav::-webkit-scrollbar { width: 6px; }
      .toc nav::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.18); border-radius: 999px; }
      .toc nav::-webkit-scrollbar-track { background: transparent; }
      .toc ul { list-style: none; padding-left: 0; margin: 0; }
      .toc li { margin: 3px 0; }
      .toc a {
        text-decoration: none;
        font-size: 12px;
        color: var(--muted);
        display: block;
        padding: 4px 6px;
        border-radius: 6px;
      }
      .toc a.active { color: var(--text); background: rgba(76, 195, 255, 0.18); }
      .toc li[data-level="1"] > a { font-size: 13px; font-weight: 700; }
      .toc li[data-level="2"] > a { padding-left: 12px; font-size: 12px; opacity: 0.92; }
      .toc li[data-level="3"] > a { padding-left: 22px; font-size: 11px; opacity: 0.78; }
      .toc li[data-level="4"] > a { padding-left: 30px; font-size: 10.5px; opacity: 0.7; }
      .doc {
        border: 1px solid var(--border);
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.02));
        border-radius: 18px;
        padding: 24px 24px 36px;
        box-shadow: var(--shadow);
      }
      .doc h1, .doc h2, .doc h3, .doc h4 {
        scroll-margin-top: 110px;
        position: relative;
      }
      .doc h1 { font-size: 26px; margin-top: 28px; }
      .doc h2 { font-size: 20px; margin-top: 24px; }
      .doc h3 { font-size: 17px; margin-top: 20px; }
      .doc h4 { font-size: 15px; margin-top: 18px; }
      .doc p { line-height: 1.7; color: rgba(255, 255, 255, 0.86); }
      .doc ul, .doc ol { padding-left: 22px; line-height: 1.7; }
      .doc ul { list-style: none; }
      .doc ul > li { position: relative; padding-left: 4px; }
      .doc ul > li::before {
        content: "•";
        position: absolute;
        left: -16px;
        top: 0.2em;
        color: rgba(255, 255, 255, 0.55);
      }
      .doc ul > li.has-toggle::before { content: ""; }
      .doc li > p { margin: 0; }
      .doc code {
        background: rgba(76, 195, 255, 0.15);
        padding: 2px 6px;
        border-radius: 6px;
        font-size: 0.92em;
      }
      .doc pre {
        background: rgba(10, 12, 18, 0.8);
        padding: 14px;
        border-radius: 12px;
        overflow: auto;
        border: 1px solid rgba(255, 255, 255, 0.08);
      }
      .doc blockquote {
        margin: 16px 0;
        padding: 12px 14px;
        border-left: 3px solid var(--accent);
        background: rgba(255, 255, 255, 0.04);
      }
      .section-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 8px;
      }
      .section-header .section-title { margin: 0; }
      .doc-section { margin-top: 20px; }
      .doc-section.level-1 { margin-top: 28px; }
      .doc-section.level-2 { margin-top: 22px; }
      .doc-section.level-3 { margin-top: 18px; }
      .doc-section.level-4 { margin-top: 16px; }
      .doc-section:first-child { margin-top: 0; }
      .section-toggle {
        border: none;
        background: rgba(76, 195, 255, 0.16);
        color: var(--text);
        width: 22px;
        height: 22px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 12px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        line-height: 1;
        align-self: center;
      }
      .doc-section.collapsed .section-body { display: none; }
      .list-toggle {
        border: none;
        background: rgba(255, 255, 255, 0.12);
        color: var(--text);
        border-radius: 6px;
        width: 18px;
        height: 18px;
        font-size: 11px;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        vertical-align: middle;
        margin-right: 6px;
        line-height: 1;
        transform: translateY(-1px);
      }
      .doc ul .list-toggle {
        position: relative;
        left: 0;
        top: 0;
      }
      .doc ol .list-toggle {
        margin-right: 6px;
      }
      li.list-collapsed > ul,
      li.list-collapsed > ol {
        display: none;
      }
      .toolbar {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 18px;
      }
      .progress {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 3px;
        background: rgba(76, 195, 255, 0.15);
        z-index: 20;
      }
      .progress > span {
        display: block;
        height: 100%;
        width: 0;
        background: linear-gradient(90deg, var(--accent), var(--accent-2));
        transition: width 0.1s ease-out;
      }
      .back-top {
        position: fixed;
        right: 20px;
        bottom: 20px;
        border: 1px solid var(--border);
        background: rgba(10, 12, 18, 0.85);
        color: var(--text);
        border-radius: 999px;
        padding: 8px 12px;
        font-size: 12px;
        cursor: pointer;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s ease;
      }
      .back-top.show { opacity: 1; pointer-events: auto; }
      .link-preview {
        position: fixed;
        z-index: 40;
        width: min(520px, 82vw);
        max-height: 60vh;
        background: linear-gradient(180deg, rgba(8, 12, 20, 0.96), rgba(10, 12, 18, 0.92));
        border: 1px solid rgba(255, 255, 255, 0.18);
        border-radius: 16px;
        box-shadow: 0 30px 80px rgba(0, 0, 0, 0.55);
        opacity: 0;
        transform: translateY(8px);
        transition: opacity 0.15s ease, transform 0.15s ease;
        pointer-events: none;
      }
      .link-preview.show { opacity: 1; transform: translateY(0); pointer-events: auto; }
      .link-preview .preview-head {
        padding: 12px 14px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      .link-preview .preview-title {
        font-weight: 700;
        font-size: 14px;
      }
      .link-preview .preview-meta {
        font-size: 11px;
        color: var(--muted);
      }
      .link-preview .preview-body {
        padding: 12px 14px 14px;
        max-height: 46vh;
        overflow: auto;
      }
      .link-preview .preview-body::-webkit-scrollbar { width: 6px; }
      .link-preview .preview-body::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.18); border-radius: 999px; }
      .link-preview .preview-body::-webkit-scrollbar-track { background: transparent; }
      .link-preview .preview-summary {
        margin-bottom: 8px;
        padding: 8px 10px;
        border-radius: 10px;
        background: rgba(76, 195, 255, 0.12);
        font-size: 12px;
        color: rgba(255, 255, 255, 0.86);
      }
      .link-preview .preview-content {
        font-size: 12px;
        line-height: 1.6;
        color: rgba(255, 255, 255, 0.82);
      }
      .link-preview .preview-content h1 { font-size: 16px; margin: 12px 0 6px; }
      .link-preview .preview-content h2 { font-size: 14px; margin: 10px 0 6px; }
      .link-preview .preview-content h3 { font-size: 13px; margin: 8px 0 6px; }
      .link-preview .preview-content h4 { font-size: 12px; margin: 6px 0 6px; }
      .link-preview .preview-content p { margin: 6px 0; }
      .link-preview .preview-content ul,
      .link-preview .preview-content ol { padding-left: 18px; margin: 6px 0; }
      .link-preview .preview-slides {
        margin-top: 10px;
        display: grid;
        grid-auto-flow: column;
        grid-auto-columns: minmax(120px, 1fr);
        gap: 8px;
        overflow-x: auto;
        padding-bottom: 4px;
      }
      .link-preview .preview-slides img {
        width: 100%;
        height: 80px;
        object-fit: cover;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.08);
        cursor: zoom-in;
      }
      .lightbox {
        position: fixed;
        inset: 0;
        background: rgba(3, 6, 12, 0.75);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 80;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s ease;
      }
      .lightbox.show { opacity: 1; pointer-events: auto; }
      .lightbox img {
        max-width: min(92vw, 1200px);
        max-height: 88vh;
        border-radius: 16px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        box-shadow: 0 24px 70px rgba(0, 0, 0, 0.6);
      }
      .link-preview mark {
        background: rgba(255, 213, 102, 0.35);
        color: rgba(255, 255, 255, 0.95);
        padding: 0 3px;
        border-radius: 4px;
      }
      @media (max-width: 960px) {
        .layout { grid-template-columns: 1fr; }
        .toc { position: static; order: -1; }
      }
    </style>
  </head>
  <body>
    <div class="progress"><span id="progress-bar"></span></div>
    <header>
      <div class="topbar">
        <div class="brand">
          <div class="brand-title">分析稿</div>
          <div class="brand-sub">TalkDistill 输出 · 阅读版</div>
        </div>
        <div class="top-actions">
          <a class="btn" href="index.html">返回入口</a>
          <button class="btn" id="toggle-toc">目录</button>
        </div>
      </div>
    </header>

    <main class="layout">
      <article class="doc">
        <div class="toolbar">
          <button class="btn" id="collapse-headings">折叠标题</button>
          <button class="btn" id="expand-headings">展开标题</button>
          <button class="btn" id="collapse-lists">折叠列表</button>
          <button class="btn" id="expand-lists">展开列表</button>
        </div>
        <div id="doc-content"></div>
      </article>

      <aside class="toc" id="toc">
        <h3>目录</h3>
        <input type="search" id="toc-filter" placeholder="过滤标题（/ 可快速定位）" />
        <nav id="toc-list"></nav>
      </aside>
    </main>

    <button class="back-top" id="back-top">回到顶部</button>
    <div class="lightbox" id="lightbox" aria-hidden="true">
      <img id="lightbox-img" alt="slide preview" />
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script id="doc-source" type="text/markdown">{{MD_CONTENT}}</script>
    <script>
      const source = document.getElementById("doc-source").textContent;
      const content = document.getElementById("doc-content");
      const tocList = document.getElementById("toc-list");
      const tocFilter = document.getElementById("toc-filter");
      const toc = document.getElementById("toc");
      const backTop = document.getElementById("back-top");
      const lightbox = document.getElementById("lightbox");
      const lightboxImg = document.getElementById("lightbox-img");

      marked.setOptions({ gfm: true, breaks: true });
      content.innerHTML = marked.parse(source);

      function slugify(text) {
        return text
          .toLowerCase()
          .trim()
          .replace(/[^\w\u4e00-\u9fa5\s-]/g, "")
          .replace(/\s+/g, "-")
          .slice(0, 60);
      }

      function wrapSections() {
        const nodes = Array.from(content.childNodes);
        content.innerHTML = "";
        let i = 0;
        while (i < nodes.length) {
          const node = nodes[i];
          if (node.nodeType === 1 && /^H[1-4]$/.test(node.tagName)) {
            const level = Number(node.tagName[1]);
            const section = document.createElement("section");
            section.className = `doc-section level-${level}`;
            const header = document.createElement("div");
            header.className = "section-header";
            const toggle = document.createElement("button");
            toggle.className = "section-toggle";
            toggle.textContent = "–";
            toggle.addEventListener("click", () => {
              section.classList.toggle("collapsed");
              toggle.textContent = section.classList.contains("collapsed") ? "+" : "–";
            });
            node.classList.add("section-title");
            header.appendChild(toggle);
            header.appendChild(node);
            section.appendChild(header);
            const body = document.createElement("div");
            body.className = "section-body";
            i += 1;
            while (i < nodes.length) {
              const next = nodes[i];
              if (next.nodeType === 1 && /^H[1-4]$/.test(next.tagName)) {
                const nextLevel = Number(next.tagName[1]);
                if (nextLevel <= level) break;
              }
              body.appendChild(next);
              i += 1;
            }
            section.appendChild(body);
            content.appendChild(section);
          } else {
            content.appendChild(node);
            i += 1;
          }
        }
      }

      function buildToc() {
        const headings = Array.from(content.querySelectorAll("h1, h2, h3, h4"));
        const used = new Map();
        const items = headings.map((h) => {
          const text = h.textContent.trim();
          const base = slugify(text) || "section";
          const count = (used.get(base) || 0) + 1;
          used.set(base, count);
          const id = count > 1 ? `${base}-${count}` : base;
          h.id = id;
          return { id, text, level: Number(h.tagName[1]) };
        });

        const root = document.createElement("ul");
        let stack = [{ level: 1, list: root }];
        items.forEach((item) => {
          while (stack.length > 1 && item.level <= stack[stack.length - 1].level) stack.pop();
          const li = document.createElement("li");
          li.dataset.level = item.level;
          const link = document.createElement("a");
          link.href = `#${item.id}`;
          link.textContent = item.text;
          li.appendChild(link);
          stack[stack.length - 1].list.appendChild(li);
          const sub = document.createElement("ul");
          li.appendChild(sub);
          stack.push({ level: item.level, list: sub });
        });
        tocList.innerHTML = "";
        tocList.appendChild(root);
      }

      function enableListToggles() {
        const items = content.querySelectorAll("li");
        items.forEach((li) => {
          const sub = li.querySelector(":scope > ul, :scope > ol");
          if (!sub) return;
          if (li.querySelector(".list-toggle")) return;
          const btn = document.createElement("button");
          btn.className = "list-toggle";
          btn.textContent = "▾";
          btn.type = "button";
          btn.setAttribute("aria-label", "折叠列表");
          btn.addEventListener("click", (e) => {
            e.stopPropagation();
            li.classList.toggle("list-collapsed");
            btn.textContent = li.classList.contains("list-collapsed") ? "▸" : "▾";
          });
          li.classList.add("has-toggle");
          const target =
            li.querySelector(":scope > p, :scope > h1, :scope > h2, :scope > h3, :scope > h4, :scope > h5, :scope > h6") ||
            li;
          target.insertBefore(btn, target.firstChild);
        });
      }

      function setupTocSpy() {
        const links = Array.from(tocList.querySelectorAll("a"));
        const map = new Map(links.map((a) => [a.getAttribute("href").slice(1), a]));
        const headings = Array.from(document.querySelectorAll("h1, h2, h3, h4"));
        const setActive = (id) => {
          links.forEach((l) => l.classList.remove("active"));
          const link = map.get(id);
          if (link) link.classList.add("active");
        };
        let ticking = false;
        const update = () => {
          ticking = false;
          const offset = 120;
          let current = headings[0];
          for (const h of headings) {
            if (h.getBoundingClientRect().top - offset <= 0) current = h;
            else break;
          }
          if (current) setActive(current.id);
        };
        const onScroll = () => {
          if (ticking) return;
          ticking = true;
          requestAnimationFrame(update);
        };
        window.addEventListener("scroll", onScroll, { passive: true });
        window.addEventListener("resize", onScroll);
        update();
      }

      function setupToolbar() {
        document.getElementById("collapse-headings").onclick = () => {
          content.querySelectorAll(".doc-section").forEach((sec) => sec.classList.add("collapsed"));
        };
        document.getElementById("expand-headings").onclick = () => {
          content.querySelectorAll(".doc-section").forEach((sec) => sec.classList.remove("collapsed"));
        };
        document.getElementById("collapse-lists").onclick = () => {
          content.querySelectorAll("li").forEach((li) => li.classList.add("list-collapsed"));
          content.querySelectorAll(".list-toggle").forEach((btn) => (btn.textContent = "▸"));
        };
        document.getElementById("expand-lists").onclick = () => {
          content.querySelectorAll("li").forEach((li) => li.classList.remove("list-collapsed"));
          content.querySelectorAll(".list-toggle").forEach((btn) => (btn.textContent = "▾"));
        };
      }

      function setupProgress() {
        const bar = document.getElementById("progress-bar");
        const doc = document.querySelector(".doc");
        const onScroll = () => {
          const scrollTop = window.scrollY;
          const start = doc ? doc.offsetTop : 0;
          const end = doc ? doc.offsetTop + doc.scrollHeight - window.innerHeight : 0;
          const denom = Math.max(1, end - start);
          const ratio = (scrollTop - start) / denom;
          const clamped = Math.min(1, Math.max(0, ratio));
          bar.style.width = `${Math.min(100, clamped * 100)}%`;
          if (scrollTop > 360) backTop.classList.add("show");
          else backTop.classList.remove("show");
        };
        window.addEventListener("scroll", onScroll, { passive: true });
        onScroll();
      }

      function setupTocFilter() {
        tocFilter.addEventListener("input", () => {
          const q = tocFilter.value.trim().toLowerCase();
          tocList.querySelectorAll("a").forEach((a) => {
            const hit = a.textContent.toLowerCase().includes(q);
            a.parentElement.style.display = hit ? "" : "none";
          });
        });
        window.addEventListener("keydown", (e) => {
          if (e.key === "/") {
            e.preventDefault();
            tocFilter.focus();
          }
        });
      }

      function setupTocToggle() {
        document.getElementById("toggle-toc").addEventListener("click", () => {
          toc.style.display = toc.style.display === "none" ? "" : "none";
        });
      }

      const preview = document.createElement("div");
      preview.className = "link-preview";
      preview.innerHTML = `
        <div class="preview-head">
          <div class="preview-title">加载中…</div>
          <div class="preview-meta"></div>
        </div>
        <div class="preview-body">
          <div class="preview-summary" style="display:none"></div>
          <div class="preview-content"></div>
          <div class="preview-slides" style="display:none"></div>
        </div>
      `;
      document.body.appendChild(preview);

      const previewCache = new Map();
      let previewActive = null;
      let previewTimer = null;

      function parseShowUrl(href) {
        try {
          const u = new URL(href, window.location.href);
          if (!u.pathname.endsWith("show.html")) return null;
          const session = u.searchParams.get("session");
          const part = Number(u.searchParams.get("part"));
          const sec = u.searchParams.get("sec");
          if (!session || !Number.isFinite(part) || !sec) return null;
          const hit = u.searchParams.get("hit") || "";
          return { session, part, sec, hit };
        } catch (e) {
          return null;
        }
      }

      function secIdAliases(id) {
        const s = String(id || "").trim();
        if (!s) return [];
        const m = s.match(/^(sec_)(\d+)$/i);
        if (!m) return [s];
        const prefix = m[1];
        const num = String(Number(m[2]));
        if (!Number.isFinite(Number(num))) return [s];
        const pad2 = num.padStart(2, "0");
        const pad3 = num.padStart(3, "0");
        return Array.from(new Set([s, `${prefix}${num}`, `${prefix}${pad2}`, `${prefix}${pad3}`]));
      }

      function parseRegex(input) {
        const raw = String(input || "").trim();
        if (!raw) return null;
        const slashIdx = raw.lastIndexOf("/");
        if (raw.startsWith("/") && slashIdx > 0) {
          const source = raw.slice(1, slashIdx);
          const flags = (raw.slice(slashIdx + 1) || "i").replace(/g/g, "");
          try { return new RegExp(source, flags); } catch (e) {}
        }
        try { return new RegExp(raw.replace(/[.*+?^${}()|[\]\\]/g, "\\$&"), "i"); } catch (e) { return null; }
      }

      function highlightInElement(el, re) {
        if (!el || !re) return false;
        const text = el.textContent || "";
        if (!text.trim()) return false;
        const m = re.exec(text);
        if (!m) return false;
        const startIdx = m.index;
        const endIdx = startIdx + m[0].length;
        if (startIdx < 0 || endIdx <= startIdx) return false;

        const walker = document.createTreeWalker(el, NodeFilter.SHOW_TEXT, {
          acceptNode: (node) => {
            if (!node || !node.nodeValue) return NodeFilter.FILTER_REJECT;
            return NodeFilter.FILTER_ACCEPT;
          },
        });

        let node;
        let acc = 0;
        let startNode = null;
        let endNode = null;
        let startOffset = 0;
        let endOffset = 0;
        while ((node = walker.nextNode())) {
          const len = node.nodeValue.length;
          const nextAcc = acc + len;
          if (startNode == null && startIdx < nextAcc) {
            startNode = node;
            startOffset = startIdx - acc;
          }
          if (startNode != null && endIdx <= nextAcc) {
            endNode = node;
            endOffset = endIdx - acc;
            break;
          }
          acc = nextAcc;
        }
        if (!startNode || !endNode) return false;

        const wrapRangeInTextNode = (textNode, start, end) => {
          if (!textNode || start < 0 || end <= start) return null;
          const raw = textNode.nodeValue || "";
          const before = raw.slice(0, start);
          const middle = raw.slice(start, end);
          const after = raw.slice(end);
          const mark = document.createElement("mark");
          mark.textContent = middle;
          const frag = document.createDocumentFragment();
          if (before) frag.appendChild(document.createTextNode(before));
          frag.appendChild(mark);
          if (after) frag.appendChild(document.createTextNode(after));
          textNode.parentNode.replaceChild(frag, textNode);
          return mark;
        };

        if (startNode === endNode) {
          return !!wrapRangeInTextNode(startNode, startOffset, endOffset);
        }

        const nodes = [];
        const walker2 = document.createTreeWalker(el, NodeFilter.SHOW_TEXT);
        while ((node = walker2.nextNode())) nodes.push(node);
        const startIndex = nodes.indexOf(startNode);
        const endIndex = nodes.indexOf(endNode);
        if (startIndex < 0 || endIndex < 0 || endIndex < startIndex) return false;

        wrapRangeInTextNode(startNode, startOffset, startNode.nodeValue.length);
        for (let i = startIndex + 1; i < endIndex; i++) {
          const midNode = nodes[i];
          if (!midNode || !midNode.nodeValue) continue;
          wrapRangeInTextNode(midNode, 0, midNode.nodeValue.length);
        }
        wrapRangeInTextNode(endNode, 0, endOffset);
        return true;
      }

      async function fetchJson(url) {
        const resp = await fetch(url, { cache: "no-cache" });
        if (!resp.ok) throw new Error(`fetch failed: ${url}`);
        return await resp.json();
      }

      async function fetchText(url) {
        const resp = await fetch(url, { cache: "no-cache" });
        if (!resp.ok) throw new Error(`fetch failed: ${url}`);
        return await resp.text();
      }

      async function loadPreviewData(info) {
        const key = `${info.session}:${info.part}`;
        let manifest = previewCache.get(key);
        if (!manifest) {
          const part = String(info.part).padStart(2, "0");
          const manifestUrl = new URL(
            `packages/parts-web/${info.session}/part_${part}/manifest.json`,
            window.location.href
          ).toString();
          manifest = await fetchJson(manifestUrl);
          previewCache.set(key, manifest);
        }

        const aliases = secIdAliases(info.sec);
        const refinedMap = (manifest.files && manifest.files.refined) || {};
        let refinedPath = null;
        for (const alias of aliases) {
          if (refinedMap[alias]) {
            refinedPath = refinedMap[alias];
            break;
          }
        }

        const planPath = manifest.files ? (manifest.files.section_manifest_plan || manifest.files.section_manifest) : null;
        let title = "";
        let summary = "";
        let slides = [];
        if (planPath) {
          const planUrl = new URL(
            `packages/parts-web/${info.session}/part_${String(info.part).padStart(2, "0")}/${planPath}`,
            window.location.href
          ).toString();
          const planJson = await fetchJson(planUrl);
          const sections = Array.isArray(planJson.sections) ? planJson.sections : [];
          const sec = sections.find((s) => aliases.includes(String(s.id)));
          if (sec) {
            title = String(sec.title || "");
            summary = String(sec.summary_hint || sec.summary || "");
            const captures = (manifest.files && manifest.files.captures) || {};
            const ids = Array.isArray(sec.material_ids) ? sec.material_ids : [];
            const partPrefix = `packages/parts-web/${info.session}/part_${String(info.part).padStart(2, "0")}/`;
            slides = ids
              .map((id) => captures[id])
              .filter(Boolean)
              .slice(0, 5)
              .map((rel) => new URL(partPrefix + rel, window.location.href).toString());
          }
        }

        let md = "";
        if (refinedPath) {
          const refinedUrl = new URL(
            `packages/parts-web/${info.session}/part_${String(info.part).padStart(2, "0")}/${refinedPath}`,
            window.location.href
          ).toString();
          md = await fetchText(refinedUrl);
        }

        if (!title) {
          const m = md.match(/^\\s*#\\s+(.+)$/m);
          if (m) title = m[1].trim();
        }

        const meta = `${info.session} · part_${String(info.part).padStart(2, "0")} · ${info.sec}`;
        return { title, summary, content: md, hit: info.hit, meta, slides };
      }

      function renderPreview(data) {
        const titleEl = preview.querySelector(".preview-title");
        const metaEl = preview.querySelector(".preview-meta");
        const summaryEl = preview.querySelector(".preview-summary");
        const contentEl = preview.querySelector(".preview-content");
        const slidesEl = preview.querySelector(".preview-slides");
        titleEl.textContent = data.title || "未命名 Section";
        metaEl.textContent = data.meta || "";
        if (data.summary) {
          summaryEl.style.display = "";
          summaryEl.textContent = data.summary;
        } else {
          summaryEl.style.display = "none";
          summaryEl.textContent = "";
        }
        contentEl.innerHTML = data.content ? marked.parse(data.content) : "<em style=\"opacity:0.6\">暂无内容</em>";

        const re = parseRegex(data.hit);
        if (re) {
          highlightInElement(summaryEl, re);
          const blocks = contentEl.querySelectorAll("p, li, h1, h2, h3, h4, blockquote");
          for (const block of blocks) {
            re.lastIndex = 0;
            if (highlightInElement(block, re)) break;
          }
        }

        if (slidesEl) {
          if (Array.isArray(data.slides) && data.slides.length) {
            slidesEl.style.display = "";
            slidesEl.innerHTML = data.slides
              .map((url, idx) => `<img data-src="${url}" alt="slide ${idx + 1}" loading="lazy" />`)
              .join("");
            const loadSlides = () => {
              slidesEl.querySelectorAll("img[data-src]").forEach((img) => {
                img.src = img.dataset.src;
                img.removeAttribute("data-src");
              });
            };
            if (typeof requestIdleCallback === "function") requestIdleCallback(loadSlides, { timeout: 400 });
            else setTimeout(loadSlides, 60);
            slidesEl.querySelectorAll("img").forEach((img) => {
              img.addEventListener("click", (e) => {
                e.stopPropagation();
                if (!img.src) return;
                lightboxImg.src = img.src;
                lightbox.classList.add("show");
                lightbox.setAttribute("aria-hidden", "false");
              });
            });
          } else {
            slidesEl.style.display = "none";
            slidesEl.innerHTML = "";
          }
        }
      }

      function positionPreview(link) {
        const rect = link.getBoundingClientRect();
        const spacing = 12;
        preview.style.display = "block";
        const box = preview.getBoundingClientRect();
        let left = rect.right + spacing;
        if (left + box.width > window.innerWidth - 12) left = rect.left - box.width - spacing;
        if (left < 12) left = 12;
        let top = rect.top;
        if (top + box.height > window.innerHeight - 12) top = window.innerHeight - box.height - 12;
        if (top < 12) top = 12;
        preview.style.left = `${left}px`;
        preview.style.top = `${top}px`;
      }

      function showPreview(link, info) {
        previewActive = link;
        if (previewTimer) clearTimeout(previewTimer);
        preview.querySelector(".preview-title").textContent = "加载中…";
        preview.querySelector(".preview-meta").textContent = "";
        preview.querySelector(".preview-summary").style.display = "none";
        preview.querySelector(".preview-content").innerHTML = "";
        preview.querySelector(".preview-slides").style.display = "none";
        preview.querySelector(".preview-slides").innerHTML = "";
        preview.classList.add("show");
        positionPreview(link);

        const key = `${info.session}:${info.part}:${info.sec}:${info.hit}`;
        const task = previewCache.get(key) || loadPreviewData(info);
        previewCache.set(key, task);
        Promise.resolve(task)
          .then((data) => {
            if (previewActive !== link) return;
            renderPreview(data);
            positionPreview(link);
          })
          .catch(() => {
            if (previewActive !== link) return;
            preview.querySelector(".preview-title").textContent = "预览加载失败";
            preview.querySelector(".preview-meta").textContent = "";
            preview.querySelector(".preview-summary").style.display = "none";
            preview.querySelector(".preview-snippet").innerHTML = "<em style=\"opacity:0.6\">请直接打开链接查看。</em>";
            positionPreview(link);
          });
      }

      function hidePreview() {
        previewActive = null;
        preview.classList.remove("show");
      }

      function setupShowLinkPreviews() {
        const links = Array.from(content.querySelectorAll("a[href*=\"show.html\"]"));
        links.forEach((link) => {
          const info = parseShowUrl(link.href);
          if (!info) return;
          link.addEventListener("mouseenter", () => showPreview(link, info));
          link.addEventListener("mousemove", () => positionPreview(link));
          link.addEventListener("mouseleave", () => {
            previewTimer = setTimeout(() => {
              if (previewActive === link) hidePreview();
            }, 120);
          });
        });
        preview.addEventListener("mouseenter", () => {
          if (previewTimer) clearTimeout(previewTimer);
        });
        preview.addEventListener("mouseleave", () => hidePreview());
        window.addEventListener("scroll", () => {
          if (previewActive && !preview.matches(":hover")) hidePreview();
        }, { passive: true });
      }

      function setupLightbox() {
        lightbox.addEventListener("click", () => {
          lightbox.classList.remove("show");
          lightbox.setAttribute("aria-hidden", "true");
          lightboxImg.src = "";
        });
        window.addEventListener("keydown", (e) => {
          if (e.key === "Escape" && lightbox.classList.contains("show")) {
            lightbox.classList.remove("show");
            lightbox.setAttribute("aria-hidden", "true");
            lightboxImg.src = "";
          }
        });
      }

      backTop.addEventListener("click", () => window.scrollTo({ top: 0, behavior: "smooth" }));

      wrapSections();
      buildToc();
      enableListToggles();
      setupToolbar();
      setupTocSpy();
      setupProgress();
      setupTocFilter();
      setupTocToggle();
      setupShowLinkPreviews();
      setupLightbox();
    </script>
  </body>
</html>
