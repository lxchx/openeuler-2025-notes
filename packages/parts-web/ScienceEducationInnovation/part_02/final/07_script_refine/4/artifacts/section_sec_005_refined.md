# PetPS：基于网卡 SG-DMA 的高性能持久性内存（PM）参数存储机制

## 1. 背景与挑战
在参数服务器（Parameter Server, PS）架构中，引入持久性内存（Persistent Memory, PM）旨在平衡存储容量与成本。然而，实际部署中发现系统吞吐量受限于 CPU 瓶颈（利用率达 100%），而非网络或存储带宽。

### 1.1 核心痛点：序列化开销
*   **资源消耗**：参数的序列化与聚集（Aggregation）过程占据了约 35% 的 CPU 资源。
*   **性能衰减诱因**：在 DRAM 环境下，序列化开销尚可接受；但在 PM 环境下，由于 PM 的访问延迟高于 DRAM，CPU 在执行逐个参数拷贝至缓冲区的过程中，高加载延迟导致 CPU 耗时显著增加，形成严重的性能瓶颈。

## 2. 核心设计：网卡聚集机制 (NIC Aggregation)
为了规避 CPU 直接访问 PM 带来的延迟瓶颈，PetPS 利用商用网卡中常被忽视的 **SG-DMA（Scatter-Gather DMA）** 功能，将参数聚集任务从 CPU 卸载（Offload）至网卡。

### 2.1 工作流程
1.  **描述符发射**：CPU 不再直接执行内存拷贝，而是构建包含参数源地址（PM 空间）和目的地址的描述符（Descriptors）。
2.  **异步聚集**：CPU 将描述符提交给网卡后即可释放，由网卡硬件自动完成内存数据的拉取与聚集。
3.  **协同访存**：整个过程实现了 CPU 与网卡的协同工作，CPU 无需直接参与 PM 数据的搬运，从而有效规避了 PM 的高加载延迟。

## 3. 数据一致性保障
由于网卡异步拉取数据与 CPU 更新参数可能存在并发冲突（即网卡读取时参数版本发生更新），PetPS 设计了专门的一致性维护机制：

*   **写时拷贝 (Copy-on-Write, CoW)**：当参数需要更新时，不直接覆盖原数据，确保网卡读取的是一致的历史版本。
*   **空间回收**：引入**基于 Epoch 的空间回收机制**，确保已失效的旧版本参数在所有读取操作完成后能被安全回收。

## 4. 性能表现与价值
实验数据表明，PetPS 在保持高性能的同时显著优化了成本结构：

| 维度 | 表现描述 |
| :--- | :--- |
| **吞吐量** | 较经典 PS 系统有大幅提升 |
| **延迟** | 与纯 DRAM 系统基本持平 |
| **成本** | 相比纯 DRAM 方案降低了约 30% |

## 5. 小结
PetPS 通过利用网卡的硬件 DMA 能力，成功解决了 PM 存储层中的 CPU 瓶颈问题。这种“协同访存”的设计思路，为高延迟存储介质在高性能计算场景中的应用提供了有效的参考路径。